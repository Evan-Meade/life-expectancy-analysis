---
title: "Evan Analysis"
author: "Evan Meade"
date: "4/26/2021"
output:
  html_fragment:
    self_contained: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Summary

* Developed countries have 12 year higher life expectancies than developing countries, on average
* Average national life expectancy is increasing at about a third of a year per year 
* Errors in the 9-parameter model are approximately normal
* Average errors for each country (averaged over time) are also approximately normal
* There are outliers over- and under-performing on average over this time period

Next steps:

* Statistically test for significance of these over- and under-performers
* Try adding Status.proxy and Year as parameters to the model for increased accuracy

## Imports

```{r imports}
library(tidyverse)
library(car)

data <- read_csv("life_CLEAN.csv")
data
```

## Linear Test

```{r linear_test}
data %>% gather(Predictor, x, Schooling:thinness.10.19.years) %>%
  ggplot() +
    geom_point(aes(x, Life.expectancy, color = Predictor), alpha = 0.1) +
    geom_smooth(aes(x, Life.expectancy, group = Predictor),
                color = "black", method = "lm", se = FALSE) +
    facet_wrap(~ Predictor, scales = "free_x") +
    theme(legend.position = "none") +
    labs(title = "Scatter Plots of Life Expectancy vs. Each Predictor")
```

## Temporal Analysis

```{r over_time}
year_averages <- aggregate(Life.expectancy ~ Year, data = data, FUN = mean)

ggplot(data = year_averages, mapping = aes(x = Year, y = Life.expectancy)) +
  geom_line() +
  labs(title = "Average National Life Expectancy Over Time",
       x = "Year",
       y = "Average National Life Expectancy (Years)") +
  stat_smooth(method = "lm", se = FALSE, linetype = "dashed")
# savefig("life_expectancy__year.png")

summary(lm(Life.expectancy ~ Year, data = year_averages))
```

```{r status_time}
status_averages <- aggregate(Life.expectancy ~ Year + Status, data = data, FUN = mean)

ggplot(data = status_averages, mapping = aes(x = Year, y = Life.expectancy)) +
  geom_line(mapping = aes(color = Status)) +
  labs(title = "Average National Life Expectancy Over Time, By Development Status",
       x = "Year",
       y = "Average National Life Expectancy (Years)") +
  stat_smooth(mapping = aes(group = Status), method = "lm", se = FALSE,
              color = "black", size = 0.5, linetype = "dashed")
```

```{r status_proxy}
data$Status.proxy <- as.integer(factor(data$Status, levels = c("Developing",
                                                               "Developed"),
                                       labels = c(0, 1))) - 1
summary(lm(Life.expectancy ~ Status.proxy + Year, data = data))
```

So clearly country status is a large factor in life expectancy over time. On average, developed countries have life expectancies over 12 years higher than developing countries. Additionally, every year raises the global life expectancy by about a third of a year. These coefficients are highly significant and graphically the trends look relatively constant. If we extrapolate this pattern forwards, that means each person can expect to life on average, 1.5 times as long as the life expectancy when they were born. For people born around 2000, that's about 116 years old.

## Model Fitting

```{r model_fit}
model <- lm(Life.expectancy ~ Schooling + GDP + Alcohol + BMI +
              percentage.expenditure + Income.composition.of.resources +
              HIV.AIDS + thinness.5.9.years + thinness.10.19.years, data = data)
summary(model)

# Refining that to significance
vif(model)
model <- lm(Life.expectancy ~ Schooling + GDP + Alcohol + BMI +
              percentage.expenditure + Income.composition.of.resources +
              HIV.AIDS + thinness.10.19.years, data = data)
summary(model)

vif(model)
model <- lm(Life.expectancy ~ Schooling + GDP + Alcohol + BMI +
              Income.composition.of.resources +
              HIV.AIDS + thinness.10.19.years, data = data)
summary(model)
```

## Over- and Under-Performing Countries

```{r predict}
data$y.hat <- predict(model, data)
data$error <- data$Life.expectancy - data$y.hat

country_subset <- c("Norway", "China", "Ghana", "Chile", "Vietnam")
ggplot(data = data[which(data$Country %in% country_subset), ]) +
  geom_line(mapping = aes(x = Year, y = error, color = Country))
```

```{r errors}
ggplot(data = data) +
  geom_histogram(mapping = aes(x = error), binwidth = 1) +
  labs(title = "Residuals For All Life Expectancy Observations",
       x = "Residual (Years)",
       y = "Count")

ggplot(data = data) +
  geom_boxplot(mapping = aes(x = Year, group = Year, y = error)) +
  labs(title = "Residual Distributions Over Time",
       x = "Year",
       y = "Residual (Years)")
```

We can investigate the probability that a country would have error sample means of these magnitudes.

$$
H_0: \epsilon\sim N(0,\sigma^2)\text{ for all countries }
\\
H_1: \epsilon\not\sim N(0,\sigma^2)\text{ for at least one country }
\\
z_j = \frac{1}{n_j}\sum_{i=1}^{n_j}\epsilon = \frac{1}{n_j}\sum_{i=1}^{n_j}N(0,\sigma^2) \sim N(0,\sigma^2/n_j) \text{ for each country }j
$$

```{r over_under}
# av_error <- aggregate(error ~ Country, data = data, FUN = mean)
rse <- summary(model)$sigma
av_error <- data %>%
  group_by(Country) %>%
  summarize(count = n(), total_error = sum(error), mean_error = total_error / count) %>%
  mutate(p_val = pnorm(abs(total_error), mean = 0, sd = sqrt(count) * rse, lower.tail = FALSE))

(signif_error <- av_error %>%
    filter(p_val < 0.001) %>%
    arrange(p_val))

ggplot(data = av_error) +
  geom_histogram(mapping = aes(x = mean_error)) +
  labs(title = "Average Residuals of Each Nation",
       x = "Average Residual (Years)",
       y = "Count")
```

```{r outliers}
outlier_order <- c(head(order(av_error$mean_error, decreasing = TRUE), 5),
                   tail(order(av_error$mean_error, decreasing = TRUE), 5))
av_error$over.rank <- order(av_error$mean_error, decreasing = TRUE)
outliers <- av_error$Country[outlier_order]
print(paste0(c("Top Over-perfomers: ", outliers[1:5])))
print(paste0(c("Top Under-perfomers: ", outliers[10:6])))
outlier_data <- data[which(data$Country %in% outliers), ]
outlier_data$Country <- factor(outlier_data$Country, levels = outliers)

ggplot(data = outlier_data) +
  geom_line(mapping = aes(x = Year, y = error, color = Country)) +
  scale_color_brewer(palette = "RdYlGn", direction = -1) +
  labs(title = "Top Over- and Under-Performing National Life Expectancies",
       x = "Year",
       y = "Residual")
```

```{r error_signif}

```








